using System;
using System.IO;
using System.Linq;
using EasyConsole;
using EducationalMalwareKit.Domain.Build;
using EducationalMalwareKit.Domain.Payloads;

namespace EducationalMalwareKit.CLI.Pages
{
    public class UserOptionsPage : Page
    {
        public UserOptionsPage(Program program) : base("Options", program)
        {
        }

        public override void Display()
        {
            base.Display();

            var userOptions = new UserOptions(StringHelper.GetSudoRandomString(12), StringHelper.GetSudoRandomString(14));
            userOptions.ExecutableName = Input.ReadString("EXE name:");

            Output.WriteLine(ConsoleColor.Cyan, "The provided icon will be used for the produced executable. The Payload may contain a default icon file");

            userOptions.IconFilePath =
                InputHelper.GetValidIconFilePath
                (
                    Input.ReadString("[Optional] Path to icon file (.ico):"),
                    Kernel.GetPayloadDefaultIcon()
                );

            userOptions.Debug = InputHelper.ParseStringAsBool(Input.ReadString("Enable debug mode [N]/[y]:"));
            userOptions.CleanOutputDirectory = InputHelper.ParseStringAsBool(Input.ReadString("Clean output dir [N]/[y]:"));

            var payloadManifest = Kernel.MalwareBuild.Manifest;

            if (payloadManifest.Language == PayloadManifest.LanguageCPlusPlus)
            {
                if (Kernel.HasPackager())
                {
                    userOptions.PackageOutput = InputHelper
                        .ParseStringAsBool(Input.ReadString("Package (compress) output [N]/[y]:"));
                }
                else
                {
                    Output.WriteLine(ConsoleColor.Red, "Configure packager to allow compression of output");
                }
            }

            if (payloadManifest.Language == PayloadManifest.LanguageCSharp)
            {
                userOptions.EncryptPayload = InputHelper
                    .ParseStringAsBool(Input.ReadString("Encrypt Payload (w/ runtime decryption) [N]/[y]:"));
            }

            if (payloadManifest.Config.Any())
            {
                Output.WriteLine(ConsoleColor.Cyan, "Options set. Configure the payload ...");
                Output.WriteLine(ConsoleColor.Yellow, "Caution: The toolkit cannot verify config values. Input with care\n");

                foreach (var key in payloadManifest.Config.Keys.ToList())
                {
                    var configValue = InputHelper.ReadRequiredString(key.ToUpper() + "=>");
                    payloadManifest.Config[key] = configValue;
                }
            }

            Kernel.MalwareBuild.UserOptions = userOptions;
            Program.NavigateTo<BuildPage>();
        }
    }
}
